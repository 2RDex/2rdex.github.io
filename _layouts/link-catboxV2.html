<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="utf-8" />
<meta name="robots" content="noindex" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>Catbox Viewer — Fullscreen</title>
<link rel="icon" href="https://catbox.moe/pictures/favicon.ico">
<style>
  :root { color-scheme: dark; }
  * { box-sizing: border-box; }
  html, body { height: 100%; }
  body { margin: 0; background: #000; font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; overflow: hidden; }

  .stage {
    position: fixed; inset: 0; width: 100vw; height: 100dvh;
    display: grid; place-items: center; background: var(--bg, #000);
    touch-action: none;
  }
  .media {
    max-width: 100vw; max-height: 100dvh; width: auto; height: auto;
    object-fit: contain; /* เริ่มต้น */
    user-select: none; -webkit-user-drag: none; will-change: transform;
    transform-origin: center center;
  }
  .cover .media { object-fit: cover; width: 100vw; height: 100dvh; }

  /* เฉพาะ img ซูม/แพนได้ */
  img.media.zoomable { border-radius: 0; box-shadow: none; }

  .hud {
    position: fixed; left: 0; right: 0; top: 0;
    padding: 10px 14px; display: flex; gap: 8px;
    align-items: center; justify-content: space-between;
    background: linear-gradient(to bottom, rgba(0,0,0,.6), rgba(0,0,0,0));
    color: #fff; opacity: 0; pointer-events: none; transition: opacity .2s; font-size: 14px;
  }
  .hud.show { opacity: 1; pointer-events: auto; }
  .row { display: flex; gap: 8px; align-items: center; }
  .btn { appearance: none; border: 1px solid rgba(255,255,255,.18); background: rgba(255,255,255,.08);
    color: #fff; padding: 8px 12px; border-radius: 999px; cursor: pointer; font: inherit; backdrop-filter: blur(6px); text-decoration: none; }
  .btn:hover { background: rgba(255,255,255,.15); }
  .badge { opacity: .85; }

  .help { position: fixed; inset: 0; display: grid; place-items: center; padding: 24px; color: #ddd; background: #0b0b0b; }
  .help code { background: #121212; padding: 2px 6px; border-radius: 6px; }
</style>
</head>
<body>

<div class="stage" id="stage"></div>

<div class="hud" id="hud">
  <div class="row"><span class="badge" id="name"></span></div>
  <div class="row">
    <button class="btn" id="fit">Contain</button>
    <button class="btn" id="zoomIn" title="Zoom in (ภาพเท่านั้น)">+</button>
    <button class="btn" id="zoomOut" title="Zoom out (ภาพเท่านั้น)">−</button>
    <button class="btn" id="zoomReset" title="Reset zoom (ภาพเท่านั้น)">Reset</button>
    <a class="btn" id="openSrc" target="_blank" rel="noopener">Open</a>
    <a class="btn" id="download" download>Save</a>
  </div>
</div>

<script>
(function () {
  const qs = new URLSearchParams(location.search);
  let raw = (qs.get('code') || qs.get('url') || '').trim();
  let ext = (qs.get('ext') || '').trim().toLowerCase();

  // แยกนามสกุลจาก raw ถ้าไม่ได้ส่ง ext มา
  if (raw && !ext && raw.includes('.')) {
    const dot = raw.lastIndexOf('.');
    if (dot > 0 && dot < raw.length - 1) {
      ext = raw.slice(dot + 1).toLowerCase();
      raw = raw.slice(0, dot);
    }
  }

  const code = (raw.match(/[a-zA-Z0-9]+/) || [''])[0];
  const safeExt = (ext.match(/[a-z0-9]+/) || [''])[0];

  // bg color
  const bg = (qs.get('bg') || '').trim();
  if (bg) {
    const stage = document.getElementById('stage');
    stage.style.setProperty('--bg', bg.startsWith('#') ? bg : /^([0-9a-f]{3}|[0-9a-f]{6})$/i.test(bg) ? '#'+bg : bg);
  }

  const startMode = (qs.get('mode') || 'contain').toLowerCase(); // contain|cover

  const stageEl = document.getElementById('stage');
  const hud = document.getElementById('hud');
  const nameEl = document.getElementById('name');
  const fitBtn = document.getElementById('fit');
  const openBtn = document.getElementById('openSrc');
  const dlBtn = document.getElementById('download');
  let showHudTimer = null;

  const imageExt = ['png','jpg','jpeg','gif','webp','avif','bmp'];
  const videoExt = ['mp4','webm','ogg','mov','m4v'];

  function showHelp() {
    document.body.innerHTML = `
      <div class="help">
        <div>
          <h1>Catbox Viewer — Fullscreen</h1>
          <p>ตัวอย่าง:</p>
          <ul>
            <li><code>/cb/?code=1njba5&ext=png</code></li>
            <li><code>/cb/?code=1njba5.png</code></li>
            <li><code>/cb/?code=kbe4kh&ext=mp4</code></li>
            <li><code>/cb/?code=kbe4kh.mp4</code></li>
          </ul>
          <p>ออปชัน: <code>&mode=contain|cover</code>, <code>&bg=%23000</code></p>
        </div>
      </div>`;
  }

  function toggleHud(force) {
    clearTimeout(showHudTimer);
    if (force === true) hud.classList.add('show');
    else if (force === false) hud.classList.remove('show');
    else hud.classList.toggle('show');
    if (hud.classList.contains('show')) {
      showHudTimer = setTimeout(() => hud.classList.remove('show'), 2000);
    }
  }

  // ซูม/แพน (เฉพาะภาพ)
  let zoom = 1, panX = 0, panY = 0, panning = false, lastX = 0, lastY = 0, mediaEl = null;
  function applyTransform() { if (mediaEl && mediaEl.tagName === 'IMG') mediaEl.style.transform = `translate(${panX}px, ${panY}px) scale(${zoom})`; }
  function zoomBy(delta) { if (mediaEl?.tagName !== 'IMG') return; zoom = Math.min(8, Math.max(0.25, zoom * delta)); applyTransform(); }
  function resetZoom() { if (mediaEl?.tagName !== 'IMG') return; zoom = 1; panX = 0; panY = 0; applyTransform(); }

  function setMode(mode) {
    if (mode === 'cover') { stageEl.classList.add('cover'); fitBtn.textContent = 'Cover'; }
    else { stageEl.classList.remove('cover'); fitBtn.textContent = 'Contain'; }
  }

  function isImage(ext) { return imageExt.includes(ext); }
  function isVideo(ext) { return videoExt.includes(ext); }

  document.addEventListener('DOMContentLoaded', () => {
    if (!(code && safeExt)) return showHelp();

    const url = `https://files.catbox.moe/${code}.${safeExt}`;
    nameEl.textContent = `${code}.${safeExt}`;
    openBtn.href = url;
    dlBtn.href = url;
    dlBtn.download = `${code}.${safeExt}`;
    setMode(startMode);

    // เคลียร์เวที
    stageEl.innerHTML = '';
    if (isImage(safeExt)) {
      const img = document.createElement('img');
      img.className = 'media zoomable';
      img.id = 'media';
      img.alt = `${code}.${safeExt}`;
      img.src = url;
      img.referrerPolicy = 'no-referrer';
      mediaEl = img;
      stageEl.appendChild(img);

      img.addEventListener('error', () => {
        document.body.innerHTML = `<div class="help"><div><h1>โหลดภาพไม่สำเร็จ</h1><p><code>${url}</code></p></div></div>`;
      });

      // Gesture: double click/tap -> toggle fit
      img.addEventListener('dblclick', () => fitBtn.click());

      // Wheel zoom
      stageEl.addEventListener('wheel', (e) => {
        e.preventDefault();
        zoomBy(e.deltaY < 0 ? 1.15 : 1/1.15);
      }, { passive: false });

      // Pan
      stageEl.addEventListener('pointerdown', (e) => {
        panning = true; lastX = e.clientX; lastY = e.clientY;
        stageEl.setPointerCapture(e.pointerId);
      });
      stageEl.addEventListener('pointermove', (e) => {
        if (!panning) return;
        panX += (e.clientX - lastX); panY += (e.clientY - lastY);
        lastX = e.clientX; lastY = e.clientY; applyTransform();
      });
      stageEl.addEventListener('pointerup', () => { panning = false; });
      stageEl.addEventListener('pointercancel', () => { panning = false; });

    } else if (isVideo(safeExt)) {
      const vid = document.createElement('video');
      vid.className = 'media';
      vid.id = 'media';
      vid.src = url;
      vid.controls = true;
      vid.playsInline = true; // มือถือไม่เด้งเต็มจอ
      vid.preload = 'metadata';
      mediaEl = vid;
      stageEl.appendChild(vid);

      vid.addEventListener('error', () => {
        document.body.innerHTML = `<div class="help"><div><h1>โหลดวิดีโอไม่สำเร็จ</h1><p><code>${url}</code></p></div></div>`;
      });

      // ดับเบิลคลิก/แตะสองครั้ง -> toggle fit (cover/contain)
      vid.addEventListener('dblclick', () => fitBtn.click());

    } else {
      document.body.innerHTML = `<div class="help"><div><h1>ไม่รองรับไฟล์ .${safeExt}</h1></div></div>`;
      return;
    }

    // โชว์ HUD เมื่อขยับ/แตะ
    ['mousemove','touchstart'].forEach(evt => document.addEventListener(evt, () => toggleHud(true)));

    // ปุ่ม HUD
    fitBtn.addEventListener('click', () => {
      const isCover = stageEl.classList.contains('cover');
      setMode(isCover ? 'contain' : 'cover');
    });
    document.getElementById('zoomIn').addEventListener('click', () => zoomBy(1.25));
    document.getElementById('zoomOut').addEventListener('click', () => zoomBy(1/1.25));
    document.getElementById('zoomReset').addEventListener('click', resetZoom);

    // คีย์ลัดทั่วไป
    document.addEventListener('keydown', (e) => {
      // สลับ fit
      if (e.key === 'f' || e.key === 'F') fitBtn.click();
      // ภาพ: ซูม
      if (mediaEl?.tagName === 'IMG') {
        if (e.key === '+' || e.key === '=') zoomBy(1.25);
        if (e.key === '-' || e.key === '_') zoomBy(1/1.25);
        if (e.key === '0') resetZoom();
        if (e.key === 'h' || e.key === 'H') toggleHud();
      }
      // วิดีโอ: คุม playback
      if (mediaEl?.tagName === 'VIDEO') {
        const v = mediaEl;
        if (e.code === 'Space' || e.key.toLowerCase() === 'k') { e.preventDefault(); v.paused ? v.play() : v.pause(); }
        if (e.key.toLowerCase() === 'm') v.muted = !v.muted;
        if (e.key === 'ArrowRight') v.currentTime = Math.min((v.duration||1e9), v.currentTime + 5);
        if (e.key === 'ArrowLeft') v.currentTime = Math.max(0, v.currentTime - 5);
        if (e.key === 'ArrowUp') { e.preventDefault(); v.volume = Math.min(1, v.volume + 0.05); }
        if (e.key === 'ArrowDown') { e.preventDefault(); v.volume = Math.max(0, v.volume - 0.05); }
      }
    });

    // เริ่มโชว์ HUD แป๊บหนึ่ง
    toggleHud(true);
  });
})();
</script>

</body>
</html>
